<!DOCTYPE html>
<html>
  <head>
      <title>Snap Install Tester</title>
      <link rel="icon" type="image/x-icon" href="icon.png">
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width"/>
      <meta property="og:title" content="Install any published Snap for testing" />
      <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
      <style type="text/css">
        body { 
          display:flex;
          justify-content:center;
          align-items:center;
          height:100vh;
          background-color:#fff;
        }
        form { 
          width:30em;
          height:5em;
        }
        img { vertical-align:top; margin-top:-3px; }
        a, a:link { 
          color:#2196f3 !important; 
        }
        .btn { 
          height:1.5rem;
          line-height:1.0;
          margin-top:-4px; 
          background-color:rgb(3, 125, 214); 
        }
        .btn.btn-primary { 
          background-color:rgb(3, 125, 214); 
          border-color:rgb(3, 125, 214); 
        }
        .btn.btn-primary:hover { 
          background-color:rgb(21, 101, 192); 
          border-color:rgb(21, 101, 192); 
        }
      </style>
  </head>
  <body>
    <form action="" id="installForm">
      <img src="icon.png" width="36" height="36" alt=""> 
      <input type="text" placeholder="Snap ID" name="snapId" id="snapId"> 
      <input type="text" placeholder="Snap Version" name="snapVersion" id="snapVersion"> 
      <button type="submit" disabled id="installButton" class="btn btn-primary">Install</button>
    </form>
    
    <script type="text/javascript">

const snapId = 'npm:social-names-snap';
const snapName = 'Social Names';
const snapVersion = '0.1.3';  

/* 
 * Use EIP-6963 to detect MetaMask
 */

const MetaMaskFound = async (providerDetail) => { 

  const provider = providerDetail.provider; 

  document.getElementById('installButton').disabled = false; 

  document.getElementById('installForm').addEventListener("submit", (e) => { 

    e.preventDefault(); 

    let snapId = ''; 
    let snapVersion = ''; 

    const formElements = e.target.elements; 

    // Iterate over the form elements
    for (let i = 0; i < formElements.length; i++) {
      const element = formElements[i];
      if (element.name==='snapId') { // Only log elements with a name attribute
        snapId = element.value;     
      }
      else if (element.name==='snapVersion') { 
        snapVersion = element.value; 
      }
    }

    // Try to install Snap

    if(snapId.length < 1) { return false; }

    if(!snapId.startsWith('npm:')) { 
      snapId = `npm:${snapId}`; 
    }

    provider.request({ 
      method: 'wallet_requestSnaps', 
      params: 
      {
        [snapId]: { 
          version: snapVersion
        }
      },
    }); 

    return false; 
  }); 
/*
  document.getElementById('loading').className = "found"; 

  const btn = document.createElement("button"); 
  btn.className = "btn btn-primary btn-lg"; 
  btn.textContent = "Install "+snapName; 

  const provider = providerDetail.provider; 

  btn.onclick = async (event) => { 
    event.preventDefault(); 
    try { 
      const result = await provider.request({ 
        method: 'wallet_requestSnaps', 
        params: 
        {
          [snapId]: { 
            version: snapVersion
          }
        },
      }); 

      if(result) { 
        try { 
          const snaps = await provider.request({
            method: 'wallet_getSnaps',
          }); 
          if( Object.keys(snaps).includes(snapId) ) { 
            // the snap is installed and connected 
            btn.textContent = "Installed!"; 
            btn.onclick = null; 
            btn.disabled = true; 
          }
          else { 
            // the snap was not installed 
          }
        }
        catch { }
      }
    }
    catch { }
  }; 
  document.getElementById('loading').textContent = "";
  document.getElementById('loading').appendChild(btn); 

  */

}; 

window.onload = function() {

  window.addEventListener(
    "eip6963:announceProvider",
    (event) => {
      /* event.detail contains the discovered provider interface */ 
      const providerDetail = event.detail; 
      
      /* 
       * You could take one of these cases and use it for your needs,
       * or set up a conditional that takes any of these possibilities, 
       * or prompt the user to choose which MetaMask flavor they want to use 
       * in case they have multiple MetaMask extensions installed at the same time
       */
      if(providerDetail.info.rdns == "io.metamask") { 
        /* this is MetaMask */
        MetaMaskFound(providerDetail); 
      }
      else if(providerDetail.info.rdns == "io.metamask.flask") { 
        /* this is MetaMask Flask */ 
        MetaMaskFound(providerDetail); 
      }
      else if(providerDetail.info.rdns == "io.metamask.mmi") { 
        /* this is MetaMask Institutional */ 
        MetaMaskFound(providerDetail); 
      }
    }
  );

  window.dispatchEvent(new Event("eip6963:requestProvider"));
/*
  setTimeout(() => { 
    if("found"!==document.getElementById('loading').className) { 
      document.getElementById('loading').textContent = ""; 
      document.getElementById('loading').insertAdjacentHTML("afterbegin", "Please install <a href='https://metamask.io/'>MetaMask</a> first.");  
    }
  }, 1000)
  */

}

    </script>
  </body>
</html>
